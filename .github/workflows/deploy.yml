name: StatVoiceBot
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "üöÄ Deploying to projects directory..."
            
            # 1. –°–û–ó–î–ê–ï–ú –°–¢–†–£–ö–¢–£–†–£ –ü–ê–ü–û–ö
            echo "Step 1: Creating projects structure..."
            PROJECTS_DIR="$HOME/projects"
            PROJECT_DIR="$PROJECTS_DIR/stat-voice-bot"
            
            mkdir -p "$PROJECTS_DIR"
            cd "$PROJECTS_DIR"
            
            echo "Projects directory: $PROJECTS_DIR"
            echo "Project directory: $PROJECT_DIR"
            ls -la
            
            # 2. –ö–õ–û–ù–ò–†–£–ï–ú –†–ï–ü–û–ó–ò–¢–û–†–ò–ô
            echo "Step 2: Cloning/updating repository..."
            if [ -d "$PROJECT_DIR" ]; then
              echo "Project exists, updating..."
              cd "$PROJECT_DIR"
              git pull origin main
            else
              echo "Cloning new project..."
              git clone https://github.com/${{ github.repository }} "$PROJECT_DIR"
              cd "$PROJECT_DIR"
            fi
            
            # 3. –°–û–ó–î–ê–ï–ú .env
            echo "Step 3: Creating .env file..."
            cat > .env << EOF
            TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
            CONNECTION_YANDEX_FOLDER_ID=${{ secrets.CONNECTION_YANDEX_FOLDER_ID }}
            EOF
            
            echo "‚úÖ .env created at: $(pwd)/.env"
            
            # 4. –ó–ê–ü–£–°–ö–ê–ï–ú DOCKER
            echo "Step 4: Starting Docker..."
            docker-compose down 2>/dev/null || true
            docker-compose up -d --build
            
            # 5. –ü–†–û–í–ï–†–Ø–ï–ú
            echo "Step 5: Verifying..."
            sleep 5
            
            if docker ps --format "{{.Names}}" | grep -q "stat_voice_bot"; then
              echo "‚úÖ Bot deployed successfully!"
              echo "üìÅ Location: $PROJECT_DIR"
              echo "üê≥ Container: stat_voice_bot"
            
              # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
              echo ""
              echo "üìÇ Projects structure:"
              tree -L 2 "$PROJECTS_DIR" || ls -la "$PROJECTS_DIR"
            else
              echo "‚ùå Bot failed to start"
              docker-compose logs
              exit 1
            fi