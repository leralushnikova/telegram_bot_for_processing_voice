name: StatVoiceBot
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_timeout: 20m
          script: |
            echo "üöÄ Deploying..."
            
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
            PROJECT_DIR="$HOME/projects/stat-voice-bot"
            mkdir -p "$PROJECT_DIR"
            cd "$PROJECT_DIR"
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
            git clone https://github.com/${{ github.repository }} . 2>/dev/null || git pull
            
            # –°–æ–∑–¥–∞–µ–º .env
            cat > .env << EOF
            TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
            YANDEX_FOLDER_ID=${{ secrets.YANDEX_FOLDER_ID }}
            YANDEX_AUTH_ID=${{ secrets.YANDEX_AUTH_ID }}
            YANDEX_AUTH_SERVICE_ACCOUNT_ID=${{ secrets.YANDEX_AUTH_SERVICE_ACCOUNT_ID }}
            YANDEX_AUTH_PRIVATE_KEY="${{ secrets.YANDEX_AUTH_PRIVATE_KEY }}"
            EOF
            
            #  –£–¥–∞–ª—è–µ–º –í–°–ï Docker –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
            docker-compose down --rmi all --volumes --remove-orphans 2>/dev/null || true
            docker system prune -af
            
            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ —Å–æ–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–π
            docker-compose build --no-cache --pull
            docker-compose up -d
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º
            sleep 15
            
            echo "‚úÖ Deployed fresh image"