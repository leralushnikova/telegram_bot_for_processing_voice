name: StatVoiceBot
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_timeout: 30m  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç!
          script: |
            echo "üöÄ Deploying..."
            
            # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            PROJECT_DIR="$HOME/projects/stat-voice-bot"
            mkdir -p "$PROJECT_DIR"
            cd "$PROJECT_DIR"
            
            # –ö–ª–æ–Ω–∏—Ä—É–µ–º
            git clone https://github.com/${{ github.repository }} . 2>/dev/null || git pull
            
            # .env
            cat > .env << EOF
            TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
            CONNECTION_YANDEX_FOLDER_ID=${{ secrets.CONNECTION_YANDEX_FOLDER_ID }}
            EOF
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —Å–æ–±–∏—Ä–∞–µ–º —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º —Ç–∞–π–º–∞—É—Ç–æ–º
            docker-compose down 2>/dev/null || true
            
            # –°–æ–±–∏—Ä–∞–µ–º —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º —Ç–∞–π–º–∞—É—Ç–æ–º –¥–ª—è Docker
            timeout 600 docker-compose build --no-cache || echo "Build might be slow but continuing..."
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º
            docker-compose up -d
            
            # –ñ–¥–µ–º –¥–æ–ª—å—à–µ
            sleep 30
            
            if docker ps | grep -q "stat_voice_bot"; then
              echo "‚úÖ Success!"
            else
              echo "‚ùå Failed. Logs:"
              docker-compose logs --tail=20
              exit 1
            fi